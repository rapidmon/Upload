<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNS 예약 전송 프로그램</title>
    <link rel="icon" href="https://image.donga.com/pc/2022/images/common/favicon.ico">
    <link rel="stylesheet" href="./index.css">
    <link rel="stylesheet" href="./reset.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hahmlet:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css' rel='stylesheet' type='text/css'>
</head>
<body>
    <form id="submitForm">
        <fieldset>
            <legend>SNS 업로드 예약</legend>
            <div>
                <label>기사 요약문</label><input type="text" placeholder="기사 요약" name="summary" id="summary">
                <p id="summaryError"></p>
            </div>
            <div>
                <label>기사 링크</label><input type="url" placeholder="링크" name="link" id="link">
                <p id="linkError"></p>
            </div>
            <div>
                <label>업로드 시간</label><input type="datetime-local" name="schedule" id="schedule">
                <p id="scheduleError"></p>
            </div>
            <div>
                <label>보안 코드</label><input type="text" placeholder="입력 코드" name="code" id="code">
                <p id="codeError"></p>
            </div>
            <div>
                <input type="button" value="업로드" id="submitBtn">
            </div>
        </fieldset>
    </form>
    <section class="reserve-list-up">
        <button class="get-reserve-list-btn">예약 목록 불러오기</button>
        <ul class="reserve-list">
            <li class="reserve">
                <p class="reserve-summary">기사 요약</p>
                <p class="reserve-link">기사 링크</p>
                <p class="reserve-time">예약 시간</p>
                <p class="reserve-edit">편집</p>
            </li>
        </ul>
    </section>
</body>
<script>
    const submitBtn = document.getElementById('submitBtn');

    submitBtn.addEventListener('click', async function() {
        const summary = document.getElementById('summary');
        const link = document.getElementById('link');
        const schedule = document.getElementById('schedule');
        const code = document.getElementById('code');
        let isValid = true;
        
        // 오류 메시지 초기화
        document.getElementById('summaryError').textContent = '';
        document.getElementById('linkError').textContent = '';
        document.getElementById('scheduleError').textContent = '';
        document.getElementById('codeError').textContent = '';

        // 입력 필드 비활성화
        summary.disabled = true;
        link.disabled = true;
        schedule.disabled = true;
        code.disabled = true;
        
        // 기사 요약문 검증
        if (!summary.value.trim()) {
            document.getElementById('summaryError').textContent = '기사 요약문을 입력해주세요.';
            isValid = false;
        }
        
        // 기사 링크 검증 (URL 형식)
        if (!link.value.trim() || !/^https?:\/\/.+/i.test(link.value)) {
            document.getElementById('linkError').textContent = '올바른 링크 형식을 입력해주세요.';
            isValid = false;
        }
        
        // 업로드 시간 검증
        if (!schedule.value.trim()) {
            document.getElementById('scheduleError').textContent = '업로드 시간을 설정해주세요.';
            isValid = false;
        }
        
        // 보안 코드 검증
        if (!code.value.trim()) {
            document.getElementById('codeError').textContent = '보안 코드를 입력해주세요.';
            isValid = false;
        }
        
        if (!isValid) {
            // 유효성 검사 실패 시, 입력 필드 다시 활성화
            summary.disabled = false;
            link.disabled = false;
            schedule.disabled = false;
            code.disabled = false;
            return; // API 호출 중단
        }

        // 버튼 비활성화
        submitBtn.disabled = true;

        // API Gateway 엔드포인트로 전송할 데이터 객체
        const tweetData = {
            summary: summary.value,
            link: link.value,
            schedule: schedule.value,
            code: code.value
        };
    
        // API Gateway 엔드포인트 URL
        const apiEndpoint = 'https://nu0ww2fb5l.execute-api.ap-southeast-2.amazonaws.com/upload';
    
        try {
            // Fetch API를 사용하여 데이터 전송
            const response = await fetch(apiEndpoint, {
                method: 'POST',
                body: JSON.stringify(tweetData),
                headers: {
                    'Content-Type': 'application/json'
                }
            });
    
            if (response.ok) {
                console.log('News scheduled successfully');
                alert('기사가 예약되었습니다!');
            } else {
                console.error('Failed to schedule News');
                console.log(response);
                alert('기사 예약에 실패했습니다. 보안 코드를 확인해주세요');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('기사 예약 중 에러가 발생했습니다.');
        } finally {
            // 입력 필드 다시 활성화 및 초기화
            summary.value = '';
            link.value = '';
            schedule.value = '';
            code.value = '';
            summary.disabled = false;
            link.disabled = false;
            schedule.disabled = false;
            code.disabled = false;
            submitBtn.disabled = false;
        }
    });

    const reserveList = document.querySelector('.reserve-list');
    const listUpBtn = document.querySelector(".get-reserve-list-btn");

    listUpBtn.addEventListener('click', () => {
        const userInput = prompt("코드를 입력해주세요:", ""); // 사용자에게 입력 요청
        if (userInput !== null) {
            fetch('https://nu0ww2fb5l.execute-api.ap-southeast-2.amazonaws.com/listup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ userInput: userInput }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                reserveList.style.display = "flex";
                if(data.Items.length === 0){
                    const li = document.createElement('li');
                    li.className = 'reserve';

                    const none = document.createElement('p');
                    none.className = 'reserve-none';
                    none.textContent = "예약된 기사가 없습니다.";

                    li.appendChild(none);
                    reserveList.appendChild(li);
                } else {
                    data.Items.forEach(item => {
                        // 새로운 li 요소를 생성합니다.
                        const li = document.createElement('li');
                        li.className = 'reserve';
    
                        // 각 내용을 담을 p 요소를 생성합니다.
                        const summary = document.createElement('p');
                        summary.className = 'reserve-summary';
                        summary.textContent = item.summary;
                        summary.title = item.summary;
    
                        const linkElement = document.createElement('a');
                        linkElement.href = item.News;
                        linkElement.textContent = '링크';
                        linkElement.className = 'reserve-link';
    
                        const time = document.createElement('p');
                        time.className = 'reserve-time';
                        const date = new Date(item.ReservedTime);
                        const formattedDate = date.getFullYear().toString().slice(2) + "/" + 
                                            ("0" + (date.getMonth() + 1)).slice(-2) + "/" + 
                                            ("0" + date.getDate()).slice(-2) + " " + 
                                            ("0" + date.getHours()).slice(-2) + ":" + 
                                            ("0" + date.getMinutes()).slice(-2);
                        time.textContent = formattedDate;
    
                        // 버튼을 담을 div 요소를 생성합니다.
                        const toolBtnDiv = document.createElement('div');
                        toolBtnDiv.className = 'tool-btn';
    
                        // 수정 버튼을 생성합니다.
                        const editBtn = document.createElement('button');
                        editBtn.className = 'edit-btn';
                        editBtn.textContent = '수정';
                        editBtn.title = '수정기능은 아직 구현중입니다.';
    
                        // 삭제 버튼을 생성합니다.
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = '삭제';
                        deleteBtn.setAttribute('data-news-link', item.News);
                        deleteBtn.setAttribute('data-reserved-time', item.ReservedTime);
    
                        deleteBtn.addEventListener('click', function() {
                            // 사용자에게 삭제 확인을 요청하는 경고창 표시
                            const confirmDelete = confirm("정말로 삭제하시겠습니까?");
                            if (confirmDelete) {
                                // 사용자가 '확인'을 클릭한 경우, 삭제 로직 수행
                                const newsLink = this.getAttribute('data-news-link');
                                const reservedTime = this.getAttribute('data-reserved-time');
                                fetch(`https://nu0ww2fb5l.execute-api.ap-southeast-2.amazonaws.com/delete`, {
                                    method: 'DELETE',
                                    body: JSON.stringify({ News: newsLink, ReservedTime: reservedTime }),
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.message === 'Item deleted successfully') {
                                        console.log('Item deleted');
                                        alert('예약이 취소되었습니다.');
                                        this.closest('.reserve').remove();
                                    }
                                })
                                .catch(error => {
                                    console.error('Error deleting item:', error);
                                });
                            } else {
                                // 사용자가 '취소'를 클릭한 경우, 아무것도 하지 않음
                                console.log('Deletion cancelled by the user.');
                            }
                        });
    
                        // 버튼을 div에 추가합니다.
                        toolBtnDiv.appendChild(editBtn);
                        toolBtnDiv.appendChild(deleteBtn);
    
                        // 모든 요소를 li에 추가합니다.
                        li.appendChild(summary);
                        li.appendChild(linkElement);
                        li.appendChild(time);
                        li.appendChild(toolBtnDiv);
    
                        // 완성된 li를 .reserve-list에 추가합니다.
                        reserveList.appendChild(li);
                    })
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        } else {
            console.log("사용자 입력 취소");
        }
    })
</script>
</html>